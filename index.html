<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OAuth PoC</title>
    <script src="https://unpkg.com/netlify-auth-providers"></script>
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 24px; }
      pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }
      .ok { color: green; }
      .err { color: red; }
    </style>
  </head>
  <body>
    <h1>OAuth PoC</h1>

    <p><a href="#" id="login">Authenticate with GitHub</a></p>
    <p>Token: <code id="token">not authenticated</code></p>
    <p>User emails: <pre id="emails">not authenticated</pre></p>

    <script>
      const login = document.getElementById('login');
      const tokenOut = document.getElementById('token');
      const emailsOut = document.getElementById('emails');

      login.addEventListener('click', (e) => {
        e.preventDefault();

        const authenticator = new netlify.default({}); 
        authenticator.authenticate(
          { provider: "github", scope: "user:email" },
          async function (err, data) {
            if (err) {
              tokenOut.textContent = 'Error: ' + err.message || err;
              tokenOut.className = 'err';
              return;
            }
            tokenOut.textContent = data.token;
            tokenOut.className = 'ok';

            try {
              const resp = await fetch('https://api.github.com/user/emails', {
                headers: {
                  Accept: 'application/vnd.github.v3+json',
                  Authorization: 'token ' + data.token
                }
              });
              const json = await resp.json();
              emailsOut.textContent = JSON.stringify(json, null, 2);
            } catch (e) {
              emailsOut.textContent = 'Failed to fetch GitHub emails: ' + e;
            }
          }
        );
      });
    </script>
  </body>
</html>
